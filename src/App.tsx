// EdoriFile Explorer - Main Application
// Refactored with SOLID principles using Zustand for state management

import { useState, useEffect } from 'react';
import './App.css';

// Stores
import { useAppStore, useTabStore, useClipboardStore, useFolderPrefsStore } from '@store';

// Hooks
import { useFileOperations, useKeyboardShortcuts, useKeyboardNavigation, useContextMenu, type DialogType } from '@hooks';

// Components - organized by category
import {
  TabBar,
  Sidebar,
  Toolbar,
  FileGrid,
  FileList,
  InputDialog,
  ConfirmDialog,
  PropertiesDialog
} from '@components';

function App() {
  // Dialog state (local since it's UI-only)
  const [dialog, setDialog] = useState<DialogType>(null);

  // App store
  const { drives, quickAccess, initialize } = useAppStore();

  // Folder preferences store
  const { getPrefs, setViewMode: saveFolderViewMode } = useFolderPrefsStore();

  // Get viewMode from folder prefs or default to 'grid'
  const currentPath = useTabStore((s) => s.getCurrentState().path);
  const folderPrefs = getPrefs(currentPath);
  const viewMode = folderPrefs?.viewMode || 'grid';

  // Tab store
  const {
    tabs,
    activeTabId,
    setActiveTab,
    addTab,
    closeTab,
    getCurrentState,
    getCurrentFiles,
    canGoBack,
    canGoForward,
    goBack,
    goForward,
    navigateTo,
    searchFiles,
    refresh,
    initializeFirstTab,
  } = useTabStore();

  // Clipboard store
  const clipboard = useClipboardStore((s) => s.clipboard);

  // Custom hooks
  const {
    handleCopy,
    handleCut,
    handlePaste,
    handleNewFolder,
    handleRename,
    handleDelete,
    handleSelect,
    handleOpen,
    handleSelectAll,
    goUp,
  } = useFileOperations();

  const { handleContextMenu, handleBackgroundContextMenu } = useContextMenu({ setDialog });

  useKeyboardShortcuts({
    dialog,
    setDialog,
    onNewTab: () => addTab(getCurrentState().path),
    onCloseTab: () => closeTab(activeTabId),
  });

  // Keyboard navigation for file browser
  useKeyboardNavigation({
    onOpen: handleOpen,
    onGoUp: goUp,
    onDeleteRequest: () => setDialog('delete'),
    onRenameRequest: () => setDialog('rename'),
    onSelectAll: handleSelectAll,
    isDialogOpen: dialog !== null,
  });

  // Get current state
  const currentState = getCurrentState();
  const currentFiles = getCurrentFiles();

  // Initialize app
  useEffect(() => {
    const init = async () => {
      await initialize();

      // Initialize first tab with user folder
      const qa = useAppStore.getState().quickAccess;
      if (qa.length > 0) {
        const userPath = qa[0].path
          .replace('\\Desktop', '')
          .replace('\\Downloads', '')
          .replace('\\Documents', '');
        initializeFirstTab(userPath);
      } else {
        initializeFirstTab('C:\\');
      }
    };
    init();
  }, []);

  // Get selected files from current files
  const selectedFiles = currentFiles.filter(f => currentState.selectedPaths.includes(f.path));
  const selectedFile = selectedFiles.length === 1 ? selectedFiles[0] : null;

  return (
    <div className="h-screen flex flex-col bg-[var(--color-bg-base)]">
      {/* Tab Bar */}
      <TabBar
        tabs={tabs}
        activeTabId={activeTabId}
        onTabClick={setActiveTab}
        onTabClose={closeTab}
        onNewTab={() => addTab(currentState.path)}
      />

      {/* Toolbar */}
      <Toolbar
        currentPath={currentState.path}
        canGoBack={canGoBack()}
        canGoForward={canGoForward()}
        viewMode={viewMode}
        searchQuery={currentState.searchQuery}
        hasSelection={currentState.selectedPaths.length > 0}
        hasClipboard={!!clipboard}
        onBack={goBack}
        onForward={goForward}
        onUp={goUp}
        onRefresh={refresh}
        onNavigate={navigateTo}
        onViewModeChange={(mode) => saveFolderViewMode(currentState.path, mode)}
        onSearchChange={searchFiles}
        onNewFolder={() => setDialog('newFolder')}
        onCut={handleCut}
        onCopy={handleCopy}
        onPaste={handlePaste}
        onRename={() => setDialog('rename')}
        onDelete={() => setDialog('delete')}
      />

      <div className="flex-1 flex overflow-hidden">
        {/* Sidebar */}
        <Sidebar
          drives={drives}
          quickAccess={quickAccess}
          currentPath={currentState.path}
          onNavigate={navigateTo}
        />

        {/* Main content */}
        <main
          className="flex-1 flex flex-col overflow-hidden file-area"
          onContextMenu={handleBackgroundContextMenu}
        >
          {/* Search indicator */}
          {currentState.isSearching && (
            <div className="px-4 py-2 bg-[var(--color-bg-elevated)] border-b border-[var(--color-divider)] text-[12px] text-[var(--color-text-secondary)]">
              Search results for "<span className="text-[var(--color-accent)]">{currentState.searchQuery}</span>"
            </div>
          )}

          {/* Error */}
          {currentState.error && (
            <div className="px-4 py-2 bg-[rgba(248,81,73,0.1)] border-b border-[var(--color-danger)]/20 text-[var(--color-danger)] text-[12px] flex items-center justify-between">
              <span>{currentState.error}</span>
              <button
                onClick={() => useTabStore.getState().updateTabState(activeTabId, { error: null })}
                className="hover:opacity-70"
              >
                âœ•
              </button>
            </div>
          )}

          {/* Loading */}
          {currentState.isLoading && (
            <div className="absolute inset-0 flex items-center justify-center bg-[var(--color-bg-surface)]/80 z-10">
              <div className="flex items-center gap-2 text-[var(--color-text-secondary)]">
                <div className="w-4 h-4 border-2 border-[var(--color-accent)] border-t-transparent rounded-full animate-spin" />
                Loading...
              </div>
            </div>
          )}

          {/* Files */}
          {viewMode === 'grid' ? (
            <FileGrid
              files={currentFiles}
              selectedPaths={currentState.selectedPaths}
              onSelect={handleSelect}
              onOpen={handleOpen}
              onContextMenu={handleContextMenu}
            />
          ) : (
            <FileList
              files={currentFiles}
              selectedPaths={currentState.selectedPaths}
              sortBy={currentState.sortBy}
              sortOrder={currentState.sortOrder}
              onSort={(column) => {
                const newOrder = currentState.sortBy === column && currentState.sortOrder === 'asc' ? 'desc' : 'asc';
                useTabStore.getState().updateTabState(activeTabId, { sortBy: column, sortOrder: newOrder });
              }}
              onSelect={handleSelect}
              onOpen={handleOpen}
              onContextMenu={handleContextMenu}
            />
          )}

          {/* Status bar */}
          <footer className="h-6 flex items-center px-4 bg-[var(--color-bg-base)] border-t border-[var(--color-border)] text-[11px] text-[var(--color-text-muted)]">
            <span>{currentFiles.length} items</span>
            {selectedFiles.length > 0 && (
              <>
                <span className="mx-2">|</span>
                <span className="truncate">
                  {selectedFiles.length === 1 ? selectedFiles[0].name : `${selectedFiles.length} items selected`}
                </span>
              </>
            )}
            {clipboard && (
              <>
                <span className="flex-1" />
                <span className="text-[var(--color-accent)]">
                  {clipboard.operation === 'copy' ? 'Copied' : 'Cut'}: {clipboard.items.length} item(s)
                </span>
              </>
            )}
          </footer>
        </main>
      </div>

      {/* Dialogs */}
      {dialog === 'newFolder' && (
        <InputDialog
          title="New Folder"
          placeholder="Folder name"
          confirmLabel="Create"
          onConfirm={(name) => {
            handleNewFolder(name);
            setDialog(null);
          }}
          onCancel={() => setDialog(null)}
        />
      )}

      {dialog === 'rename' && selectedFile && (
        <InputDialog
          title="Rename"
          initialValue={selectedFile.name}
          confirmLabel="Rename"
          onConfirm={(newName) => {
            handleRename(newName);
            setDialog(null);
          }}
          onCancel={() => setDialog(null)}
        />
      )}

      {dialog === 'delete' && selectedFile && (
        <ConfirmDialog
          title="Delete"
          message={`Are you sure you want to delete "${selectedFile.name}"?`}
          confirmLabel="Delete"
          confirmDanger
          onConfirm={() => {
            handleDelete();
            setDialog(null);
          }}
          onCancel={() => setDialog(null)}
        />
      )}

      {dialog === 'properties' && selectedFile && (
        <PropertiesDialog
          file={selectedFile}
          onClose={() => setDialog(null)}
        />
      )}
    </div>
  );
}

export default App;
